<view class="page">
  <!-- Cover Card -->
  <view class="card cover-card" wx:if="{{event}}">
    <view class="cover">
      <image class="cover-img" src="{{event.coverUrl}}" mode="aspectFill" wx:if="{{event.coverUrl}}" />
      <view class="cover-overlay"></view>
      <view class="cover-badge status-badge-{{event.status}}">{{event.statusText}}</view>
      <view class="type-badge" wx:if="{{event.eventTypeText}}">{{event.eventTypeText}}</view>
    </view>
    <view class="cover-body">
      <view class="title-row">
        <text class="event-title">{{event.title}}</text>
      </view>
      <view class="event-meta-chips">
        <view class="meta-chip" wx:if="{{event.eventTypeText}}">
          <text>{{event.eventTypeText}}</text>
        </view>
        <view class="meta-chip" wx:if="{{event.formatModeText}}">
          <text>{{event.formatModeText}}</text>
        </view>
      </view>

      <view class="ordered-row">
        <text class="row-label">时间</text>
        <view class="row-content">
          <text class="row-main">{{event.dateText}}{{event.eventTime ? (' ' + event.eventTime) : ''}}</text>
        </view>
      </view>

      <view class="ordered-row clickable-row" bindtap="openParticipantSheet">
        <text class="row-label">参赛选手</text>
        <view class="row-content participants-row-content">
          <view class="participants-preview" wx:if="{{participantPreview.length > 0}}">
            <image
              class="preview-avatar"
              wx:for="{{participantPreview}}"
              wx:key="id"
              src="{{item.avatarFileId}}"
              mode="aspectFill"
              wx:if="{{item.avatarFileId}}"
              style="z-index: {{participantPreview.length - index}}"
            />
            <view
              class="preview-avatar placeholder"
              wx:for="{{participantPreview}}"
              wx:key="id"
              wx:if="{{!item.avatarFileId}}"
              style="z-index: {{participantPreview.length - index}}"
            >
              <image src="/assets/icons/user-placeholder.png" mode="aspectFit" />
            </view>
          </view>
          <text class="row-main">{{participants.length}}人</text>
          <text class="row-arrow">›</text>
        </view>
      </view>

      <view class="ordered-row clickable-row" bindtap="openLocation">
        <text class="row-label">地点</text>
        <view class="row-content">
          <text class="row-main">{{event.location || '待定'}}</text>
          <text class="row-arrow" wx:if="{{event.latitude && event.longitude}}">›</text>
        </view>
      </view>

      <view class="ordered-row desc-row">
        <text class="row-label">赛事介绍</text>
        <view class="row-content desc-content">
          <text class="event-desc">{{event.description}}</text>
        </view>
      </view>

      <view class="poster-inline" wx:if="{{event.posterUrl}}">
        <image class="poster-inline-img" src="{{event.posterUrl}}" mode="widthFix" show-menu-by-longpress="true" />
      </view>

      <!-- Registration Info -->
      <view class="reg-info">
        <view class="reg-item">
          <text class="reg-label">人数上限</text>
          <text class="reg-value">{{event.maxParticipants || '不限'}}</text>
        </view>
        <view class="reg-divider"></view>
        <view class="reg-item">
          <text class="reg-label">费用</text>
          <text class="reg-value">{{event.price ? event.price + '元' : '免费'}}</text>
        </view>
        <view class="reg-divider"></view>
        <view class="reg-item">
          <text class="reg-label">已报名</text>
          <text class="reg-value">{{participants.length}}人</text>
        </view>
      </view>

      <!-- Intensity indicators removed (强度/耐力 bar) -->
    </view>
  </view>

  <!-- Detail Blocks -->
  <view class="card info-card" wx:if="{{detailBlocks.length > 0}}">
    <view class="section-header">
      <text class="section-title">活动详情</text>
      <text class="subtext">组织者发布</text>
    </view>
    <view class="detail-block-list">
      <view class="detail-block" wx:for="{{detailBlocks}}" wx:key="index" wx:for-index="blockIndex">
        <text class="detail-block-title" wx:if="{{item.title}}">{{item.title}}</text>
        <view class="detail-block-gallery" wx:if="{{item.image_urls && item.image_urls.length}}">
          <image
            class="detail-block-thumb"
            wx:for="{{item.image_urls}}"
            wx:key="*this"
            wx:for-item="img"
            wx:for-index="imgIndex"
            src="{{img}}"
            mode="aspectFill"
            data-block-index="{{blockIndex}}"
            data-img-index="{{imgIndex}}"
            bindtap="previewDetailImage"
            show-menu-by-longpress="true"
          />
        </view>
        <text class="detail-block-text" wx:if="{{item.content}}">{{item.content}}</text>
      </view>
    </view>
  </view>

  <!-- Stations Card -->
  <view class="card info-card" wx:if="{{event && stations.length > 0}}">
    <view class="section-header">
      <text class="section-title">赛事站点</text>
      <text class="subtext">共 {{stations.length}} 站</text>
    </view>
    <view class="stations-list">
      <view class="station-item" wx:for="{{stations}}" wx:key="id">
        <view class="station-order">{{item.order}}</view>
        <view class="station-info">
          <text class="station-name">{{item.name}}</text>
          <text class="station-target">{{item.targetValue}} {{item.targetUnit}}</text>
        </view>
        <view class="station-weight" wx:if="{{item.weightMale || item.weightFemale}}">
          <text wx:if="{{item.weightMale}}">♂{{item.weightMale}}kg</text>
          <text wx:if="{{item.weightFemale}}">♀{{item.weightFemale}}kg</text>
        </view>
      </view>
    </view>
  </view>

  <!-- Highlights Card -->
  <view class="card info-card" wx:if="{{event && event.highlights && event.highlights.length > 0}}">
    <text class="section-title">赛事亮点</text>
    <view class="highlight-list">
      <view class="highlight-item" wx:for="{{event.highlights}}" wx:key="index">
        <view class="highlight-dot"></view>
        <text class="highlight-text">{{item}}</text>
      </view>
    </view>
  </view>

  <!-- Album Card -->
  <view class="card info-card">
    <view class="section-header">
      <text class="section-title">赛事相册</text>
    </view>
    <text class="subtext" wx:if="{{albumSummary.canView}}">
      共 {{albumSummary.totalPhotos}} 张照片，支持查看与下载原图
    </text>
    <text class="subtext" wx:else>
      仅参赛选手可查看赛事相册
    </text>
    <view class="empty-state-inline" wx:if="{{albumSummary.totalPhotos === 0}}">
      <view class="empty-icon">
        <image src="/assets/icons/camera.png" mode="aspectFit" />
      </view>
      <text class="subtext">{{albumSummary.canView ? '暂未上传照片' : '暂未开放相册'}}</text>
    </view>
    <button class="ghost-btn album-entry-btn" bindtap="openAlbum" wx:if="{{albumSummary.canView}}">进入相册</button>
  </view>

  <!-- Empty State -->
  <view class="empty-state-box" wx:if="{{!loading && !event}}">
    <view class="empty-state-icon">
      <image src="/assets/icons/search.png" mode="aspectFit" />
    </view>
    <text class="empty-state-title">赛事不存在</text>
    <text class="empty-state-desc">该赛事可能已下架或不存在</text>
  </view>

  <view class="participant-sheet-mask" wx:if="{{showParticipantSheet}}" bindtap="closeParticipantSheet"></view>
  <view class="participant-sheet" wx:if="{{showParticipantSheet}}" catchtap="noop">
    <view class="sheet-header">
      <text class="sheet-title">参赛选手</text>
      <text class="sheet-close" bindtap="closeParticipantSheet">关闭</text>
    </view>
    <scroll-view class="sheet-list" scroll-y="{{true}}">
      <view class="sheet-empty" wx:if="{{participants.length === 0}}">
        <text class="subtext">暂无报名选手</text>
      </view>
      <view
        class="sheet-participant-item"
        wx:for="{{participants}}"
        wx:key="id"
        data-openid="{{item.userOpenid}}"
        bindtap="goRunnerProfile"
      >
        <image class="participant-avatar" src="{{item.avatarFileId}}" mode="aspectFill" wx:if="{{item.avatarFileId}}" />
        <view class="participant-avatar placeholder" wx:else>
          <image src="/assets/icons/user-placeholder.png" mode="aspectFit" />
        </view>
        <view class="participant-info">
          <text class="participant-name">{{item.nickname}}</text>
          <text class="subtext">{{item.division || '未填写组别'}}</text>
        </view>
        <text class="sheet-arrow">›</text>
      </view>
    </scroll-view>
  </view>

  <view class="bottom-action-bar" wx:if="{{event}}">
    <button class="ghost-btn action-btn share-btn" open-type="share">分享</button>
    <button class="primary-btn action-btn signup-btn" bindtap="handleRegister" disabled="{{isFull}}">
      {{isFull ? '报名已满' : (isSigned ? '已报名' : '立即报名')}}
    </button>
  </view>
</view>
