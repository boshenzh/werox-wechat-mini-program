<view class="page">
  <view class="card hero-card">
    <view class="hero-top">
      <view class="avatar-wrap">
        <image
          class="avatar"
          src="{{profile.avatarFileId}}"
          mode="aspectFill"
          wx:if="{{profile.avatarFileId}}"
        />
        <view class="avatar-placeholder" wx:else>
          <text class="avatar-text">未上传</text>
        </view>
      </view>
      <view class="hero-info">
        <view class="hero-name-wrap" wx:if="{{isEditing}}">
          <input class="hero-input" value="{{profile.nickname}}" placeholder="填写昵称" data-field="nickname" bindinput="handleInput" />
        </view>
        <text class="hero-name" wx:else>{{profile.nickname || '未命名选手'}}</text>

        <view class="tag-list" wx:if="{{!isEditing}}">
          <view class="tag" wx:for="{{profile.tags}}" wx:key="index">{{item}}</view>
          <text class="subtext" wx:if="{{profile.tags.length === 0}}">添加标签展示风格</text>
        </view>
        <view class="tag-edit" wx:else>
          <input class="form-input" value="{{tagText}}" placeholder="力量型、耐力型、战术型" data-field="tags" bindinput="handleInput" />
          <text class="subtext">多个标签请用逗号分隔</text>
        </view>

        <view class="hero-meta" wx:if="{{!isEditing}}">
          <text class="meta-item">年龄 {{profile.age || '--'}}</text>
          <text class="meta-divider">/</text>
          <text class="meta-item">心率 {{profile.heartRate || '--'}}</text>
        </view>
        <view class="hero-meta edit-meta" wx:else>
          <input class="meta-input" type="number" value="{{profile.age}}" placeholder="年龄" data-field="age" bindinput="handleInput" />
          <input class="meta-input" type="number" value="{{profile.heartRate}}" placeholder="心率" data-field="heartRate" bindinput="handleInput" />
        </view>
      </view>
    </view>

    <view class="hero-bottom">
      <view class="hero-line"></view>
      <view class="hero-row">
        <text class="subtext">角色</text>
        <text class="hero-value">{{roleLabel}}</text>
      </view>
      <view class="hero-row hero-row-inline">
        <view class="hero-inline-text">
          <text class="subtext">OpenID</text>
          <text class="hero-value" selectable="true">{{openid}}</text>
        </view>
        <button class="ghost-btn copy-btn" bindtap="copyOpenId">复制</button>
      </view>
      <view class="hero-row">
        <text class="subtext">微信号（选填）</text>
        <text class="hero-value" wx:if="{{!isEditing}}">{{profile.wechatId || '未填写'}}</text>
        <input
          class="form-input"
          wx:else
          value="{{profile.wechatId}}"
          placeholder="请输入微信号"
          data-field="wechatId"
          bindinput="handleInput"
          bindblur="handleWechatIdBlur"
        />
        <text class="subtext" wx:if="{{isEditing}}">用于匹配赛前资料</text>
      </view>
      <view class="hero-row">
        <text class="subtext">个人简介</text>
        <text class="hero-value" wx:if="{{!isEditing}}">{{profile.bio || '写下你的训练状态与目标'}}</text>
        <textarea
          class="form-textarea"
          wx:else
          value="{{profile.bio}}"
          placeholder="写下你的训练状态与目标"
          data-field="bio"
          bindinput="handleInput"
        />
      </view>
      <button class="ghost-btn" wx:if="{{isEditing}}" bindtap="cancelEdit">取消编辑</button>
    </view>
  </view>

  <view class="card stats-card">
    <view class="stats-header">
      <text class="section-title">训练评分</text>
      <text class="subtext">来自参赛记录</text>
    </view>
    <view class="stats-grid">
      <view class="stat-item">
        <text class="stat-label">强度</text>
        <text class="stat-value">{{strengthScore}}</text>
      </view>
      <view class="stat-divider"></view>
      <view class="stat-item">
        <text class="stat-label">耐力</text>
        <text class="stat-value">{{enduranceScore}}</text>
      </view>
    </view>
  </view>

  <view class="card info-card">
    <text class="section-title">个人资料</text>
    <view class="form-list">
      <view class="form-row">
        <text class="form-label">性别</text>
        <picker
          wx:if="{{isEditing}}"
          mode="selector"
          range="{{sexOptions}}"
          value="{{sexIndex}}"
          data-field="sex"
          bindchange="handlePickerChange"
        >
          <view class="picker-field {{profile.sex ? '' : 'picker-placeholder'}}">
            {{profile.sex || '未选择'}}
          </view>
        </picker>
        <text class="form-value" wx:else>{{profile.sex || '未选择'}}</text>
      </view>

      <view class="form-row">
        <text class="form-label">主要训练方向</text>
        <picker
          wx:if="{{isEditing}}"
          mode="selector"
          range="{{trainingOptions}}"
          value="{{trainingIndex}}"
          data-field="trainingFocus"
          bindchange="handlePickerChange"
        >
          <view class="picker-field {{profile.trainingFocus ? '' : 'picker-placeholder'}}">
            {{profile.trainingFocus || '未选择'}}
          </view>
        </picker>
        <text class="form-value" wx:else>{{profile.trainingFocus || '未选择'}}</text>
      </view>

      <view class="form-row">
        <text class="form-label">HYROX 参赛经验</text>
        <picker
          wx:if="{{isEditing}}"
          mode="selector"
          range="{{hyroxOptions}}"
          value="{{hyroxIndex}}"
          data-field="hyroxExperience"
          bindchange="handlePickerChange"
        >
          <view class="picker-field {{profile.hyroxExperience ? '' : 'picker-placeholder'}}">
            {{profile.hyroxExperience || '未选择'}}
          </view>
        </picker>
        <text class="form-value" wx:else>{{profile.hyroxExperience || '未选择'}}</text>
      </view>

      <view class="form-row">
        <text class="form-label">双人搭档更适合的角色</text>
        <picker
          wx:if="{{isEditing}}"
          mode="selector"
          range="{{partnerRoleOptions}}"
          value="{{partnerRoleIndex}}"
          data-field="partnerRole"
          bindchange="handlePickerChange"
        >
          <view class="picker-field {{profile.partnerRole ? '' : 'picker-placeholder'}}">
            {{profile.partnerRole || '未选择'}}
          </view>
        </picker>
        <text class="form-value" wx:else>{{profile.partnerRole || '未选择'}}</text>
      </view>

      <view class="form-row">
        <text class="form-label">你希望搭档提前知道的一件事</text>
        <textarea
          class="form-textarea"
          wx:if="{{isEditing}}"
          value="{{profile.partnerNote}}"
          placeholder="例如：节奏快时需要提醒我补水"
          data-field="partnerNote"
          bindinput="handleInput"
        />
        <text class="form-value" wx:else>{{profile.partnerNote || '暂未填写'}}</text>
      </view>

      <view class="form-row">
        <text class="form-label">MBTI</text>
        <input
          class="form-input"
          wx:if="{{isEditing}}"
          value="{{profile.mbti}}"
          placeholder="例如 ENFJ"
          data-field="mbti"
          bindinput="handleInput"
        />
        <text class="form-value" wx:else>{{profile.mbti || '暂未填写'}}</text>
      </view>
    </view>
  </view>

  <view class="card attendance-card">
    <view class="attendance-header">
      <text class="section-title">参赛记录</text>
    </view>
    <view class="attendance-list" wx:if="{{attendanceRecords.length > 0}}">
      <view class="attendance-item" wx:for="{{attendanceRecords}}" wx:key="_id">
        <view class="attendance-info">
          <text class="attendance-title">{{item.eventName || '赛事记录'}}</text>
          <text class="subtext">{{item.gymName || '未填写场馆'}}</text>
        </view>
        <view class="attendance-score">
          <text class="score-label">强度 {{item.finalStrength || 0}}</text>
          <text class="score-label">耐力 {{item.finalEndurance || 0}}</text>
        </view>
      </view>
    </view>
    <view class="empty-state" wx:else>
      <text class="subtext">暂无成绩记录</text>
    </view>
  </view>

  <view class="card admin-card" wx:if="{{isAdmin}}">
    <text class="section-title">赛事管理</text>
    <text class="subtext">仅管理员可发布赛事</text>
    <button class="primary-btn" bindtap="goAdminEvents">新增赛事</button>
  </view>

  <button class="float-edit" wx:if="{{isSelf}}" bindtap="handleEditAction">
    {{isEditing ? '保存修改' : '编辑主页'}}
  </button>
</view>
